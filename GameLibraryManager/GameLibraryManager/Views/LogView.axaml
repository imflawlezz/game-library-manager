<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:GameLibraryManager.ViewModels"
             xmlns:i="https://github.com/projektanker/icons.avalonia"
             xmlns:converters="using:GameLibraryManager.Converters"
             xmlns:spinner="using:GameLibraryManager.Controls"
             x:Class="GameLibraryManager.Views.LogView"
             x:DataType="vm:LogViewModel">
    
    <Grid RowDefinitions="*">
        
        <Border Grid.Row="0"
                Background="#161B22"
                CornerRadius="12"
                BorderBrush="#30363D"
                BorderThickness="1"
                ClipToBounds="True">
            <Grid RowDefinitions="Auto,*">
                
                <Grid Grid.Row="1">
                    <DataGrid ItemsSource="{Binding LogEntries}"
                              AutoGenerateColumns="False"
                              IsReadOnly="True"
                              GridLinesVisibility="None"
                              HeadersVisibility="Column"
                              SelectionMode="Single"
                              Background="Transparent"
                              RowBackground="Transparent"
                              CanUserReorderColumns="False"
                              CanUserResizeColumns="True"
                              IsVisible="{Binding !IsLoading}">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="ID" 
                                                Binding="{Binding LogID}" 
                                                Width="80"
                                                CanUserResize="True"
                                                MinWidth="60"/>
                            <DataGridTextColumn Header="Timestamp" 
                                                Binding="{Binding Timestamp, StringFormat='{}{0:dd.MM.yyyy HH:mm}'}" 
                                                Width="140"
                                                CanUserResize="True"
                                                MinWidth="100"/>
                            <DataGridTextColumn Header="User" 
                                                Binding="{Binding Username}" 
                                                Width="120"
                                                CanUserResize="True"
                                                MinWidth="80"/>
                            <DataGridTextColumn Header="Table" 
                                                Binding="{Binding TableName}" 
                                                Width="100"
                                                CanUserResize="True"
                                                MinWidth="80"/>
                            <DataGridTextColumn Header="Action" 
                                                Binding="{Binding Action}" 
                                                Width="100"
                                                CanUserResize="True"
                                                MinWidth="80"/>
                            <DataGridTextColumn Header="Field" 
                                                Binding="{Binding FieldName}" 
                                                Width="200"
                                                CanUserResize="True"
                                                MinWidth="100"/>
                            <DataGridTemplateColumn Header="Old Value" 
                                                     Width="200"
                                                     CanUserResize="True"
                                                     MinWidth="150">
                                <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                        <StackPanel Orientation="Horizontal" 
                                                        Spacing="8"
                                                        VerticalAlignment="Center"
                                                        IsVisible="{Binding OldValue, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                                <TextBlock Text="{Binding OldValue}"
                                                           FontSize="13"
                                                           Foreground="#8B949E"
                                                           VerticalAlignment="Center"
                                                           TextTrimming="CharacterEllipsis"
                                                       TextWrapping="NoWrap"
                                                           MaxWidth="160"/>
                                            <Button Command="{Binding $parent[DataGrid].DataContext.CopyToClipboardCommand}"
                                                        CommandParameter="{Binding OldValue}"
                                                        Classes="icon"
                                                        Padding="4"
                                                        ToolTip.Tip="Copy to clipboard">
                                                    <Button.IsVisible>
                                                        <MultiBinding Converter="{StaticResource ShouldShowCopyConverter}">
                                                            <Binding Path="OldValue"/>
                                                            <Binding Path="FieldName"/>
                                                        <Binding Path="$parent[DataGrid].DataContext"/>
                                                        </MultiBinding>
                                                    </Button.IsVisible>
                                                    <i:Icon Value="fa-solid fa-copy" 
                                                            FontSize="12"
                                                            Foreground="#6E7681"/>
                                                </Button>
                                            </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTemplateColumn Header="New Value" 
                                                     Width="200"
                                                     CanUserResize="True"
                                                     MinWidth="150">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" 
                                                        Spacing="8"
                                                        VerticalAlignment="Center"
                                                        IsVisible="{Binding NewValue, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                                <TextBlock Text="{Binding NewValue}"
                                                           FontSize="13"
                                                           Foreground="#F0F6FC"
                                                           VerticalAlignment="Center"
                                                           TextTrimming="CharacterEllipsis"
                                                       TextWrapping="NoWrap"
                                                           MaxWidth="160"/>
                                            <Button Command="{Binding $parent[DataGrid].DataContext.CopyToClipboardCommand}"
                                                        CommandParameter="{Binding NewValue}"
                                                        Classes="icon"
                                                        Padding="4"
                                                        ToolTip.Tip="Copy to clipboard">
                                                    <Button.IsVisible>
                                                        <MultiBinding Converter="{StaticResource ShouldShowCopyConverter}">
                                                            <Binding Path="NewValue"/>
                                                            <Binding Path="FieldName"/>
                                                        <Binding Path="$parent[DataGrid].DataContext"/>
                                                        </MultiBinding>
                                                    </Button.IsVisible>
                                                    <i:Icon Value="fa-solid fa-copy" 
                                                            FontSize="12"
                                                            Foreground="#6E7681"/>
                                                </Button>
                                            </StackPanel>
                                </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                    
                    <Border Background="#E00D1117"
                            IsVisible="{Binding IsLoading}">
                        <spinner:LoadingSpinner Text="Loading audit log"/>
                    </Border>
                    
                    <Border IsVisible="{Binding IsEmpty}"
                            Background="#161B22"
                            VerticalAlignment="Center"
                            HorizontalAlignment="Stretch">
                        <StackPanel VerticalAlignment="Center" 
                                    HorizontalAlignment="Center"
                                    Spacing="16">
                            <i:Icon Value="fa-solid fa-file-lines" 
                                    FontSize="48"
                                    Foreground="#6E7681"/>
                            <TextBlock Text="No log entries found"
                                       FontSize="16"
                                       Foreground="#8B949E"
                                       HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Border>
                </Grid>
            </Grid>
        </Border>
    </Grid>
</UserControl>
